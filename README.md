# UDP 协议简介

## 1️⃣ 概述

- **UDP（User Datagram Protocol，用户数据报协议）**是 **一种无连接、尽最大努力交付的传输层协议**。
- 它与 TCP 的主要区别在于：
  - **无连接**：发送数据前不需要建立连接
  - **不保证可靠性**：不重传丢失的数据，不保证顺序
  - **开销小、延迟低**：首部小、处理简单，适合高速传输和实时应用

------

## 2️⃣ UDP 特点

| 特性           | 描述                                                |
| -------------- | --------------------------------------------------- |
| 面向报文       | 每次发送的数据称为 **数据报（Datagram）**，独立传输 |
| 无连接         | 不建立 TCP 三次握手连接，发送前无需确认对方是否存在 |
| 不可靠传输     | 数据可能丢失、重复或乱序到达，由应用层处理可靠性    |
| 低开销、高速   | UDP 首部仅 8 字节，适合实时应用（语音、视频、游戏） |
| 支持广播和多播 | 可发送到广播地址或组播地址，实现一对多传输          |

------

## 3️⃣ UDP 数据报结构

UDP 数据报由 **首部 + 数据部分**组成：

**UDP 首部（8 字节）**

| 字段                  | 长度 | 说明                   |
| --------------------- | ---- | ---------------------- |
| 源端口（Source Port） | 2 B  | 发送端端口号           |
| 目的端口（Dest Port） | 2 B  | 接收端端口号           |
| 长度（Length）        | 2 B  | UDP首部 + 数据部分长度 |
| 校验和（Checksum）    | 2 B  | 可选，校验数据完整性   |

**数据部分（Payload）**

- 存放应用层数据
- 最大长度 = MTU - IP头 - UDP头

------

## 4️⃣ UDP 工作流程

1. **发送方**：
   - 应用层将数据发送给 UDP 协议栈
   - UDP 封装首部，交给 IP 层传输
2. **网络传输**：
   - 数据通过 IP、以太网等网络传输
   - 不保证顺序和可靠性
3. **接收方**：
   - IP 层收到数据后交给 UDP
   - UDP 根据 **目的端口** 将数据交给应用程序

------

## 5️⃣ UDP 应用场景

- **实时通信**：语音通话（VoIP）、视频会议
- **流媒体**：直播视频、音频播放
- **在线游戏**：低延迟数据传输
- **广播/组播服务**：局域网发现服务、DHCP



## Build Flow



```cmd
$cd udp_10Gbps_stack/example/EAP_5P_PCIe

$make
```



## Simulation



本次测试的以太网基本信息如下：

```shell
+----------------+--------------------------------------------+-----------------------------+
| Field          | Description                                | Value                      |
+----------------+--------------------------------------------+-----------------------------+
| SRC_MAC        | Source MAC address (Host)                  | AC:70:12:56:41:23          |
| DST_MAC        | Destination MAC address (FPGA)             | AC:14:45:FF:AF:C4          |
| SRC_IP         | Source IPv4 address (Host)                 | 192.168.1.149              |
| DST_IP         | Destination IPv4 address (FPGA)            | 192.168.1.144              |
| UDP_SRC_PORT   | UDP source port                            | 0x4554 (17748)             |
| UDP_DST_PORT   | UDP destination port                       | 0x8080 (32896)             |
+----------------+--------------------------------------------+-----------------------------+

```

测试内容通过python文本输入转换

```shell
+---------------------------------------------------------------------------------------------+
|                             TCP/IP Protocol Stack Requirements                              |
+----------------------+----------------------------------------------------------------------+
| python text          | Description                                                          |
+----------------------+----------------------------------------------------------------------+
| testbench_udp_gen    | 输入需要测试的文本字符，通过该脚本生成对应的udp测试数据，即对应的ascii码        |
+----------------------+----------------------------------------------------------------------+
|testbench_mac_rx_gen  | 产生mac层的数据回复帧，包括主机发送的mac地址以及数据                         |
+----------------------+----------------------------------------------------------------------+
|mac_tx_packet_decode  | 接收ip产生的mac数据包，通过计算ip的校验和以及udp的校验和来判断功能是否正确      |
+----------------------+----------------------------------------------------------------------+

```

如果文件的位置产生了变化，需要更改仿真文件的以下部分：

```verilog
    #(`CLOCK_PERIOD * 20)
    fd = $fopen("../../../../../../../python/udp-tx-data.bin", "rb");
    if (fd == 0) begin
        $display("Failed to open file!");
        $finish;
    end
    fc = $fopen("../../../../../../../python/mac-tx-data.bin", "wb");
    if (fc == 0) begin
        $display("Failed to open mac-tx-data.bin!");
        $finish;
    end
```

执行仿真时需要将对应的信号设置为ascii方便观察字符，同时需要结合对应的tkeep字段。

ex1：

执行simulation前，先执行testbench_udp_gen.py文件产生对应的测试数据。执行simulation后，当arp-tx-axis流拉高时，会带动对应的mac-tx-axis流也拉高，此时发送arp请求包。当数据包长度低于64byte时，会自动填0补充。

![image-20251024102541195](img/image-20251024102541195.png)

对应的arp回复报文如下：

![image-20251024102739070](img/image-20251024102739070.png)

此时的udp-rx-axis流如下：

![image-20251024102939232](img/image-20251024102939232.png)

选择一部分展开可以发现字节序反向，但内容并没有问题。

![image-20251024103001559](img/image-20251024103001559.png)



## Bitstream Vertify
